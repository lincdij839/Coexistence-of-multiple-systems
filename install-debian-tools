#!/bin/bash

# Debian 开发工具完整安装脚本

CONTAINER="my-debian"

echo "================================"
echo "  Debian 开发工具安装"
echo "================================"
echo ""

# 检查容器状态
if ! lxc info "$CONTAINER" &>/dev/null; then
    echo "错误: 容器 $CONTAINER 不存在"
    exit 1
fi

status=$(lxc list "$CONTAINER" -c s --format csv)
if [ "$status" != "RUNNING" ]; then
    echo "启动容器..."
    lxc start "$CONTAINER"
    sleep 3
fi

echo "请选择安装方案:"
echo ""
echo "1. 完整开发环境 (所有语言和工具) - 约 5GB"
echo "2. Web 开发 (Node.js, Python, PHP, Nginx) - 约 2GB"
echo "3. 系统开发 (C/C++, Go, Rust) - 约 1.5GB"
echo "4. Python 开发 (Python3, pip, 常用库) - 约 800MB"
echo "5. 容器开发 (Docker, Podman) - 约 500MB"
echo "6. 自定义安装"
echo ""
read -p "请选择 [1-6]: " choice

case $choice in
    1)
        echo ""
        echo "安装完整开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            set -e
            apt update
            
            # 基础工具
            DEBIAN_FRONTEND=noninteractive apt install -y \
                build-essential \
                git \
                curl \
                wget \
                vim \
                nano \
                htop \
                tmux \
                zsh \
                cmake \
                gdb \
                valgrind \
                strace \
                ltrace
            
            # Python
            DEBIAN_FRONTEND=noninteractive apt install -y \
                python3 \
                python3-pip \
                python3-venv \
                python3-dev
            
            # Node.js (从 NodeSource 安装最新版)
            curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
            DEBIAN_FRONTEND=noninteractive apt install -y nodejs
            
            # Go
            DEBIAN_FRONTEND=noninteractive apt install -y golang
            
            # Rust
            DEBIAN_FRONTEND=noninteractive apt install -y \
                rustc \
                cargo
            
            # PHP
            DEBIAN_FRONTEND=noninteractive apt install -y \
                php \
                php-cli \
                php-mysql \
                php-curl \
                php-json \
                php-mbstring \
                composer
            
            # Web 服务器
            DEBIAN_FRONTEND=noninteractive apt install -y \
                nginx \
                apache2
            
            # 数据库 (使用 mariadb 代替 mysql)
            DEBIAN_FRONTEND=noninteractive apt install -y \
                mariadb-server \
                mariadb-client \
                postgresql \
                postgresql-contrib \
                redis-server
            
            # 容器工具
            DEBIAN_FRONTEND=noninteractive apt install -y \
                docker.io \
                docker-compose
            
            # Java
            DEBIAN_FRONTEND=noninteractive apt install -y \
                openjdk-17-jdk \
                maven
            
            # Ruby
            DEBIAN_FRONTEND=noninteractive apt install -y \
                ruby \
                ruby-dev
            
            # 安装常用 Python 包
            pip3 install --break-system-packages \
                requests \
                flask \
                django \
                fastapi \
                numpy \
                pandas \
                pytest \
                black \
                pylint || true
            
            # 安装全局 npm 包
            npm install -g \
                yarn \
                pnpm \
                typescript \
                eslint \
                prettier \
                nodemon \
                pm2 || true
            
            apt autoremove -y
            apt clean
        '
        ;;
    2)
        echo ""
        echo "安装 Web 开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            set -e
            apt update
            
            # 基础工具
            DEBIAN_FRONTEND=noninteractive apt install -y \
                build-essential \
                git \
                curl \
                wget \
                vim
            
            # Python
            DEBIAN_FRONTEND=noninteractive apt install -y \
                python3 \
                python3-pip \
                python3-venv
            
            # Node.js
            curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
            DEBIAN_FRONTEND=noninteractive apt install -y nodejs
            
            # PHP
            DEBIAN_FRONTEND=noninteractive apt install -y \
                php \
                php-cli \
                php-mysql \
                composer
            
            # Web 服务器
            DEBIAN_FRONTEND=noninteractive apt install -y nginx
            
            # 数据库
            DEBIAN_FRONTEND=noninteractive apt install -y \
                mariadb-server \
                postgresql \
                redis-server
            
            # Python 包
            pip3 install --break-system-packages \
                flask \
                django \
                fastapi \
                requests || true
            
            # npm 包
            npm install -g \
                yarn \
                typescript \
                eslint \
                prettier \
                nodemon || true
            
            apt autoremove -y
            apt clean
        '
        ;;
    3)
        echo ""
        echo "安装系统开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            apt update
            DEBIAN_FRONTEND=noninteractive apt install -y \
                build-essential \
                git \
                cmake \
                gdb \
                valgrind \
                strace \
                ltrace \
                golang \
                rustc \
                cargo \
                clang \
                lldb \
                vim \
                tmux
            
            apt autoremove -y
            apt clean
        '
        ;;
    4)
        echo ""
        echo "安装 Python 开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            apt update
            DEBIAN_FRONTEND=noninteractive apt install -y \
                python3 \
                python3-pip \
                python3-venv \
                python3-dev \
                git \
                vim
            
            pip3 install --break-system-packages \
                requests \
                flask \
                django \
                fastapi \
                numpy \
                pandas \
                matplotlib \
                jupyter \
                pytest \
                black \
                pylint \
                mypy
            
            apt autoremove -y
            apt clean
        '
        ;;
    5)
        echo ""
        echo "安装容器开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            apt update
            DEBIAN_FRONTEND=noninteractive apt install -y \
                docker.io \
                docker-compose \
                podman \
                buildah \
                skopeo \
                git \
                vim
            
            systemctl enable docker
            systemctl start docker
            
            apt autoremove -y
            apt clean
        '
        ;;
    6)
        echo ""
        echo "可用的工具包:"
        echo "  build-essential    # C/C++ 编译工具"
        echo "  python3-pip        # Python 包管理"
        echo "  nodejs npm         # Node.js"
        echo "  golang             # Go 语言"
        echo "  rustc cargo        # Rust 语言"
        echo "  php composer       # PHP"
        echo "  openjdk-17-jdk     # Java"
        echo "  docker.io          # Docker"
        echo "  nginx              # Web 服务器"
        echo "  mysql-server       # MySQL 数据库"
        echo "  postgresql         # PostgreSQL"
        echo ""
        read -p "输入要安装的包名 (空格分隔): " packages
        
        if [ -n "$packages" ]; then
            lxc exec "$CONTAINER" -- bash -c "apt update && DEBIAN_FRONTEND=noninteractive apt install -y $packages"
        fi
        ;;
    *)
        echo "无效选择"
        exit 1
        ;;
esac

echo ""
echo "================================"
echo "  安装完成！"
echo "================================"
echo ""
echo "验证安装:"
lxc exec "$CONTAINER" -- bash -c '
    echo ""
    for tool in gcc python3 node go rustc php docker nginx mysql; do
        if command -v $tool &>/dev/null; then
            version=$(command -v $tool &>/dev/null && $tool --version 2>&1 | head -1 || echo "已安装")
            echo "  ✓ $tool"
        fi
    done
'

echo ""
echo "进入容器: my-debian"
