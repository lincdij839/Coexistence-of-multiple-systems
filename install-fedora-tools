#!/bin/bash

# Fedora 开发工具完整安装脚本

CONTAINER="my-fedora"

echo "================================"
echo "  Fedora 开发工具安装"
echo "================================"
echo ""

# 检查容器状态
if ! lxc info "$CONTAINER" &>/dev/null; then
    echo "错误: 容器 $CONTAINER 不存在"
    exit 1
fi

status=$(lxc list "$CONTAINER" -c s --format csv)
if [ "$status" != "RUNNING" ]; then
    echo "启动容器..."
    lxc start "$CONTAINER"
    sleep 3
fi

echo "请选择安装方案:"
echo ""
echo "1. 完整开发环境 (所有语言和工具) - 约 5GB"
echo "2. Web 开发 (Node.js, Python, PHP, Nginx) - 约 2GB"
echo "3. 系统开发 (C/C++, Go, Rust) - 约 1.5GB"
echo "4. Python 开发 (Python3, pip, 常用库) - 约 800MB"
echo "5. 容器开发 (Podman, Buildah) - 约 500MB"
echo ""
read -p "请选择 [1-5]: " choice

case $choice in
    1)
        echo ""
        echo "安装完整开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            dnf update -y
            dnf install -y @development-tools \
                git curl wget vim nano htop tmux zsh \
                python3 python3-pip python3-devel \
                nodejs npm \
                golang rust cargo \
                php php-cli php-mysqlnd composer \
                nginx httpd \
                mariadb-server postgresql-server redis \
                podman buildah skopeo \
                java-latest-openjdk-devel maven \
                ruby ruby-devel \
                cmake gdb valgrind strace
            
            pip3 install requests flask django fastapi numpy pandas pytest black pylint 2>/dev/null || true
            npm install -g yarn typescript eslint prettier nodemon 2>/dev/null || true
            dnf clean all
        '
        ;;
    2)
        echo ""
        echo "安装 Web 开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            dnf update -y
            dnf install -y \
                git curl wget vim \
                nginx \
                nodejs npm \
                python3 python3-pip \
                php php-cli php-mysqlnd composer \
                mariadb-server postgresql-server redis
            
            pip3 install flask django fastapi requests 2>/dev/null || true
            npm install -g yarn typescript eslint prettier nodemon 2>/dev/null || true
            dnf clean all
        '
        ;;
    3)
        echo ""
        echo "安装系统开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            dnf update -y
            dnf install -y @development-tools \
                git cmake gdb valgrind strace \
                golang rust cargo \
                clang lldb vim tmux
            dnf clean all
        '
        ;;
    4)
        echo ""
        echo "安装 Python 开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            dnf update -y
            dnf install -y \
                python3 python3-pip python3-devel \
                git vim
            
            pip3 install requests flask django fastapi numpy pandas matplotlib jupyter pytest black pylint mypy 2>/dev/null || true
            dnf clean all
        '
        ;;
    5)
        echo ""
        echo "安装容器开发环境..."
        lxc exec "$CONTAINER" -- bash -c '
            dnf update -y
            dnf install -y \
                podman buildah skopeo podman-compose \
                git vim
            dnf clean all
        '
        ;;
    *)
        echo "无效选择"
        exit 1
        ;;
esac

echo ""
echo "================================"
echo "  安装完成！"
echo "================================"
echo ""
echo "验证安装:"
lxc exec "$CONTAINER" -- bash -c '
    echo ""
    for tool in gcc python3 node go rustc php podman nginx; do
        if command -v $tool &>/dev/null; then
            echo "  ✓ $tool"
        fi
    done
'

echo ""
echo "进入容器: my-fedora"
